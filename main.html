<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth-compat.js"></script>
    <!-- Assuming firebase-config.js and cardData.js are in the same directory -->
    <script src="firebase-config.js"></script>
    <script src="cardData.js"></script>
    <script src="messageData.js"></script>
    <title>Our Memory</title>
    <link href='https://fonts.googleapis.com/css2?family=Montserrat&family=Kalam:wght@300;400;700' rel='stylesheet'>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 fill=%22%23d81b60%22>‚ù§</text></svg>">
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #ffd1dc; /* Pink pastel background */
            font-family: 'Montserrat';
            position: relative;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
            padding-bottom: 80px; /* Space at the bottom */
        }

        /* Loading overlay for authentication checking */
        #loadingOverlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 209, 220, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #e91e63;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            position: relative;
            z-index: 2;
        }

        .heart {
            position: fixed; /* Changed from absolute to fixed */
            color: #ff6b81;
            font-size: 24px;
            animation: fall 4s linear forwards;
            z-index: 1;
            pointer-events: none; /* Ensures hearts don't interfere with clicks */
        }

        @keyframes fall {
            0% {
                transform: translateY(-100px) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) rotate(360deg);
                opacity: 0;
            }
        }

        .title {
            color: #d81b60;
            text-align: center;
            font-size: 36px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            font-family: 'Kalam';
        }

        .main-content {
            display: flex;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        .card-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 30px; /* Increased spacing between cards */
            max-width: 1010px;
            margin: 0 auto;
        }

        .card {
            width: 180px;
            height: 250px; /* Changed from square to rectangle */
            perspective: 1000px;
            cursor: pointer;
            margin-bottom: 20px;
            position: relative;
            transition: transform 0.3s ease; /* Add transition for smooth tilt */
        }

        /* Special card frame styling */
        .card.special {
            position: relative;
        }

        .card.special::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: linear-gradient(45deg, #ff6b9d, #ffd93d, #6bcf7f, #4d96ff, #9b59b6, #ff6b9d);
            background-size: 400% 400%;
            border-radius: 18px;
            z-index: -1;
            animation: specialGlow 3s ease-in-out infinite;
            filter: blur(2px);
        }

        .card.special {
            --special-icon: '‚≠ê';
            --font-size: 20px;
            --animation: sparkle 2s ease-in-out infinite;
        }

        .card.special::after {
            content: var(--special-icon);
            position: absolute;
            top: -15px;
            right: -10px;
            font-size: var(--font-size);
            z-index: 10;
            animation: var(--animation);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.8);
        }

        .card.sad::before {
            content: '';
            position: absolute;
            top: -8px;
            left: -8px;
            right: -8px;
            bottom: -8px;
            background: linear-gradient(45deg, #4d96ff, #3a3830, #2e3830, #4d96ff, #333031, #534d4f);
            background-size: 400% 400%;
            border-radius: 18px;
            z-index: -1;
            animation: specialGlow 3s ease-in-out infinite;
            filter: blur(2px);
        }

        .card.sad::after {
            content: 'üåßÔ∏è';
            position: absolute;
            top: -15px;
            right: -10px;
            font-size: 35px;
            z-index: 10;
            animation: sad-sparkle 4s ease-in-out infinite;
            text-shadow: 0 0 10px rgba(31, 30, 25, 0.8);
        }

        @keyframes specialGlow {
            0%, 100% {
                background-position: 0% 50%;
                opacity: 0.7;
            }
            50% {
                background-position: 100% 50%;
                opacity: 1;
            }
        }

        @keyframes sparkle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 1;
            }
        }

        @keyframes sad-sparkle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(5deg);
                opacity: 1;
            }
        }

        @keyframes heart-sparkle {
            0%, 100% {
                transform: scale(0.9) rotate(-15deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(15deg);
                opacity: 1;
            }
        }

        /* Special card inner glow */
        .card.special .card-inner {
            box-shadow: 0 0 20px rgba(255, 182, 193, 0.6);
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.6s;
        }

        .card.flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .card-front {
            background-color: #f8bbd0;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .card-front img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-back {
            transform: rotateY(180deg);
            background-color: #f48fb1;
            /* padding: 15px; */
            color: #4a0012;
            font-size: 14px;
            line-height: 1.4;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        /* Special card back styling */
        .card.special .card-back {
            background: linear-gradient(135deg, #ffeef7, #f8bbd0);
            border: 2px solid #ff69b4;
        }

        .card-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 8px;
            color: #4a0012;
            padding-top: 7px;
        }

        /* Special card header */
        .card.special .card-header {
            color: #d81b60;
            text-shadow: 1px 1px 2px rgba(255, 182, 193, 0.5);
            position: relative;
        }

        .card.special .card-header::after {
            content: '‚ô•Ô∏è';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
        }

        .card.sad .card-header {
            text-shadow: 1px 1px 2px rgba(255, 182, 193, 0.5);
            position: relative;
        }

        .card.sad .card-header::after {
            content: '‚ù§Ô∏è‚Äçü©π';
            position: absolute;
            right: -20px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 15px;
        }

        .card-divider {
            width: 80%;
            height: 2px;
            background-color: #e91e63;
            margin-bottom: 10px;
        }

        .card-message {
            flex: 1;
            overflow-y: auto;
            width: 100%;
            padding: 5px 0;
            display: flex;
            align-items: flex-start; /* Change from center to allow scrolling from top */
            justify-content: center;
        }

        .card-message p {
            width: 100%;
            margin: 0;
            overflow-wrap: break-word;
            padding: 0 10px;

        }

        /* Added scrollbar styling for the message area */
        .card-message::-webkit-scrollbar {
            width: 5px;
        }

        .card-message::-webkit-scrollbar-thumb {
            background: #e91e63;
            border-radius: 10px;
        }

        .card-message::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }

        /* Initial heart rain animation */
        @keyframes initialHeartRain {
            0% {
                transform: translateY(-100vh) translateX(0) rotate(0deg);
                opacity: 1;
            }
            100% {
                transform: translateY(100vh) translateX(20px) rotate(360deg);
                opacity: 0;
            }
        }

        .initial-heart {
            position: fixed; /* Changed from absolute to fixed */
            color: #ff6b81;
            font-size: 24px;
            animation: initialHeartRain 4s linear forwards;
            z-index: 1;
            pointer-events: none;
        }

        .logout-btn {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 10;
            background-color: #f06292;
            color: white;
            border: none;
            border-radius: 20px;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        .logout-btn:hover {
            background-color: #e91e63;
        }

          /* Pagination styles */
        .pagination-container {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 30px 0;
            gap: 10px;
        }
        
        .pagination-btn {
            background-color: #f06292;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 16px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 40px;
        }
        
        .pagination-btn:hover {
            background-color: #e91e63;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .pagination-btn:disabled {
            background-color: #ffcdd2;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .pagination-btn.active {
            background-color: #e91e63;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }
        .pagination-info {
            font-size: 16px;
            color: #d81b60;
            margin: 0 15px;
            font-weight: bold;
        }
        .pagination-numbers {
            display: flex;
            gap: 5px;
        }
        .pagination-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
        .pagination-ellipsis {
            color: #d81b60;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        /* Year dropdown styling */
        .year-dropdown-container {
            text-align: center;
        }

        .year-dropdown-container label {
            font-size: 18px;
            color: #d81b60;
            font-weight: bold;
            margin-right: 10px;
        }

        .year-dropdown-container select {
            padding: 8px 20px;
            border-radius: 20px;
            border: 2px solid #f06292;
            background-color: #fff;
            color: #d81b60;
            font-size: 16px;
            cursor: pointer;
            outline: none;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            appearance: none; /* Remove default dropdown arrow */
            -webkit-appearance: none;
            -moz-appearance: none;
            /* background-image: url('data:image/svg+xml;utf8,<svg fill="%23d81b60" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); */
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 20px;
        }

        .year-dropdown-container select:hover {
            border-color: #e91e63;
        }

        .music-controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10;
            display: flex;
            gap: 10px;
        }

        .music-controls button {
            background-color: #f06292;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .music-controls button:hover {
            background-color: #e91e63;
        }
        
        /* Picture frames on sides */
        .side-pictures {
            position: fixed;
            top: 50%;
            transform: translateY(-50%);
            z-index: 2;
            display: flex;
            flex-direction: column;
            gap: 40px;
        }
        
        @media (max-width: 1400px) {
            .side-pictures {
                position: static;
                transform: none;
                flex-direction: row;
                justify-content: center;
                flex-wrap: wrap;
                margin: 30px 0;
            }
        }
        
        .side-pictures.left {
            left: 30px;
        }
        
        .side-pictures.right {
            right: 30px;
        }
        
        .picture-frame {
            width: 150px;
            height: 200px;
            background-color: #fff;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2), inset 0 0 5px rgba(0, 0, 0, 0.1);
            padding: 5px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease;
        }
        
        .picture-frame img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .left .picture-frame:nth-child(1) {
            transform: rotate(-5deg);
        }
        
        .left .picture-frame:nth-child(2) {
            transform: rotate(3deg);
        }
        
        .right .picture-frame:nth-child(1) {
            transform: rotate(6deg);
        }
        
        .right .picture-frame:nth-child(2) {
            transform: rotate(-4deg);
        }
        
        .picture-frame:hover {
            transform: scale(1.05) rotate(0deg);
            z-index: 10;
        }

        /* Slideshow styling */
        .slideshow-container {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .slideshow-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }

        .slideshow-slide.active {
            opacity: 1;
        }

        .slideshow-controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            gap: 5px;
            z-index: 5;
        }

        .slideshow-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
        }

        .slideshow-dot.active {
            background-color: #fff;
        }

        .slideshow-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(255, 255, 255, 0.3);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            line-height: 1;
            z-index: 5;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }

        .slideshow-btn:hover {
            background-color: rgba(255, 255, 255, 0.5);
        }

        .slideshow-prev {
            left: 5px;
        }

        .slideshow-next {
            right: 5px;
        }

        /* Responsive layout */
        @media (max-width: 1024px) {
            .card-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .card-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .pagination-container {
                flex-wrap: wrap;
                gap: 5px;
            }
            
            .pagination-info {
                width: 100%;
                text-align: center;
                margin: 10px 0;
            }
        }

        @media (max-width: 480px) {
            .card-grid {
                grid-template-columns: 1fr;
            }
            
            .title {
                font-size: 28px;
            }
             
            .pagination-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }

        .rainbow-hue {
            background: linear-gradient(45deg, 
                #8B0000, #FF4500, #DAA520, #038b03, 
                #aa52e9, #ee05ee
            );
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: bold;
            animation: rainbow 3s ease-in-out infinite;
        }

        @keyframes rainbow {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* New styles for the letter */
        .letter-container {
            position: relative;
            width: 300px; /* Adjust as needed */
            height: 100px; /* Adjust as needed */
            background: #fdf5e6; /* Creamy background for the letter */
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            cursor: pointer;
            transition: all 0.5s ease-in-out;
            transform-style: preserve-3d; /* For 3D flip effect */
            transform: rotateX(0deg); /* Initial state */
            margin: 30px 0; /* Add margin to separate from other content */
        }

        .letter-container.open {
            height: 150px; /* Expand height when open */
            transform: rotateX(5deg); /* Slight tilt when open */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .letter-closed, .letter-open {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backface-visibility: hidden;
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
        }

        .letter-closed {
            opacity: 1;
            z-index: 2;
            transform: rotateY(0deg);
        }

        .letter-container.open .letter-closed {
            opacity: 0;
            transform: rotateY(180deg);
        }

        .letter-open {
            opacity: 0;
            z-index: 1;
            transform: rotateY(-180deg); /* Start rotated for flip */
            color: #4a0012;
        }

        .letter-container.open .letter-open {
            opacity: 1;
            transform: rotateY(0deg);
            z-index: 3; /* Bring to front when open */
        }

        .letter-closed .title {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .open-hint, .close-hint {
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            color: #888;
        }

        .love-message {
            font-family: 'Kalam', cursive;
            font-size: 20px;
            color: #d81b60;
            margin-top: 15px;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .dropdown-container select {
            /* for Firefox */
            -moz-appearance: none;
            /* for Safari, Chrome, Opera */
            -webkit-appearance: none;
        }

    </style>
</head>
<body>
    <!-- Loading overlay while checking authentication -->
    <div id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <div class="container">
        <h1 class="title"><span id="todayDate" class="rainbow-hue"></span> <br> We've Shared <span id="daysCounter" class="rainbow-hue"></span> Beautiful Days Together ‚òÄÔ∏è<br> <span id="daysCounterSpecial" class="rainbow-hue"></span> Since Our Special Days ‚ô•Ô∏è<br> Here is a few of our memory üì∏</h1>

        <!-- Left side pictures -->
        <div class="side-pictures left">
            <div class="picture-frame">
                <img src="./assets/img/unnamed0.jpg" alt="Love Memory 1">
            </div>
            <div class="picture-frame">
                <img src="./assets/img/unnamed (3).jpg" alt="Love Memory 2">
            </div>
        </div>
        
        <div class="main-content">
            <div class="card-grid">
                <!-- Cards will be dynamically generated here -->
            </div>
        </div>

        <!-- Year dropdown -->
        <div class="year-dropdown-container">
            <!-- <label for="yearSelect">Select Year:</label> -->
            <select id="yearSelect"></select>
        </div>

         <!-- Pagination controls -->
        <div class="pagination-container">
            <button class="pagination-btn" id="prevBtn">‚ùÆ</button>
            <div class="pagination-numbers" id="pageNumbers"></div>
            <button class="pagination-btn" id="nextBtn">‚ùØ</button>
        </div>
        
        <div class="pagination-info" id="paginationInfo"></div>
        
        <!-- Right side pictures -->
        <div class="side-pictures right">
            <div class="picture-frame">
                <img src="./assets/img/unnamed (4).jpg" alt="Love Memory 3">
            </div>
            <div class="picture-frame">
                <img src="./assets/img/fd13d578-84f2-4535-b54f-1ea4d39a19d7.jfif" alt="Love Memory 4">
            </div>
        </div>

        <!-- Interactive Love Letter -->
        <div class="letter-container" id="loveLetter">
            <div class="letter-closed">
                <h1 class="title">Our Love Message ‚ô•Ô∏è</h1>
            </div>
            <div class="letter-open">
                <!-- <h1 class="title">Our Special Message</h1> -->
                <p class="love-message"></p>
            </div>
        </div>
        	
        <button id="logoutButton" class="logout-btn">Logout</button>

    </div>

    <div class="music-controls">
        <button id="playMusic">üîä</button>
    </div>

    <audio id="bgMusic" allow="autoplay" loop>
        <!-- <source src="./assets/audio/Photograph - Ed Sheeran - t·∫£i mp3-l·ªùi b√†i h√°t.mp3" type="audio/mpeg"> -->
         <source src="./assets/audio/Elliot James Reay - I Think They Call This Love (Official Music Video).mp3" type="audio/mpeg">
        
        Your browser does not support the audio element.
    </audio>

    <script>
        // Get references to DOM elements
        const loadingOverlay = document.getElementById('loadingOverlay');
        const logoutButton = document.getElementById('logoutButton');
        const cardGrid = document.querySelector('.card-grid'); // Get card grid element
        const yearSelect = document.getElementById('yearSelect'); // Get year select element
        const loveLetter = document.getElementById('loveLetter'); // Get love letter container
        const loveMessageElement = loveLetter.querySelector('.love-message'); // Get message paragraph inside love letter

        // Pagination variables
        let currentPage = 1;
        let groupedCardData = []; // This will store cards grouped by month for the selected year
        let totalPages = 0;
        let currentYear = new Date().getFullYear(); // Default to current year        

        // Function to get a random romantic message
        function getRandomMessage() {
            const randomIndex = Math.floor(Math.random() * romanticMessages.length);
            return romanticMessages[randomIndex];
        }

        // Event listener for the love letter
        loveLetter.addEventListener('click', () => {
            loveLetter.classList.toggle('open');
            if (loveLetter.classList.contains('open')) {
                let textContent = getRandomMessage();
                if (textContent === "Meat anh b·∫±ng m·ªçi gi√°c quan") {
                    loveMessageElement.style.fontFamily = "'Montserrat', sans-serif";
                } else {
                    loveMessageElement.style.fontFamily = "'Kalam', cursive";
                }
                
                loveMessageElement.textContent = textContent;
                createHeartRain(20); // More hearts when the letter opens
            } else {
                loveMessageElement.textContent = ''; // Clear message when closed
            }
        });

        // Check authentication state on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Show loading overlay while checking auth
            loadingOverlay.style.display = 'flex';
            
            // Listen for authentication state changes
            firebase.auth().onAuthStateChanged((user) => {
                if (user) {
                    // User is signed in, hide loading overlay and initialize page
                    console.log('User is signed in:', user.email);
                    loadingOverlay.style.display = 'none';
                    initializePage();
                } else {
                    // No user is signed in, redirect to login page
                    console.log('No user signed in, redirecting to login');
                    window.location.href = 'index.html';
                }
            });
        });
        
        // Initialize page content after authentication confirmation
        function initializePage() {
            const todayDate = new Date().toLocaleDateString('en-GB', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            document.getElementById('todayDate').innerHTML = `<span>${todayDate}</span>`;
            
            const dateAmount = daysSince("2025-02-27");
            document.getElementById('daysCounter').innerHTML = `<span>${dateAmount}</span>`;

            const dateAmountSpecial = daysSince("2025-05-04");
            document.getElementById('daysCounterSpecial').innerHTML = `<span>${dateAmountSpecial}</span>`;
            
            // Initialize music
            initializeMusic();
            
            // Populate year dropdown and set initial year
            populateYearDropdown();
            yearSelect.value = currentYear; // Set default selected year
            
            // Group cards by month for the initial year and calculate total pages
            groupedCardData = groupCardsByMonth(cardData, currentYear);
            totalPages = groupedCardData.length;
            
            // Render cards for the current page and set up pagination
            renderCards();
            createPagination();
            
            // Set up slideshows
            setupSlideshows();
            
            // Start heart animations
            startHeartAnimations();
        }

        // Function to populate the year dropdown
        function populateYearDropdown() {
            const years = new Set();
            cardData.forEach(card => {
                const parts = card.date.split('/');
                let year = parts.length === 3 ? parseInt(parts[2]) : new Date().getFullYear();
                years.add(year);
            });

            const sortedYears = Array.from(years).sort((a, b) => a - b); // Sort years ascending

            yearSelect.innerHTML = ''; // Clear existing options
            sortedYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearSelect.appendChild(option);
            });

            // Add event listener for year change
            yearSelect.addEventListener('change', (event) => {
                currentYear = parseInt(event.target.value);
                currentPage = 1; // Reset to first page when year changes
                groupedCardData = groupCardsByMonth(cardData, currentYear);
                totalPages = groupedCardData.length;
                renderCards();
                updatePagination();
            });
        }
        
        // Handle logout
        logoutButton.addEventListener('click', () => {
            loadingOverlay.style.display = 'flex';
            firebase.auth().signOut()
                .then(() => {
                    // Successfully signed out, redirect to login page
                    window.location.href = 'index.html';
                })
                .catch((error) => {
                    console.error('Error signing out:', error);
                    loadingOverlay.style.display = 'none';
                });
        });

        /**
         * Groups cards by month for a specific year and sorts them chronologically.
         * Assumes date format "dd/mm" or "dd/mm/yyyy". If year is not provided, uses selectedYear.
         * @param {Array<Object>} cards - The array of card data.
         * @param {number} selectedYear - The year to filter cards by.
         * @returns {Array<Object>} An array of month objects, each containing a 'key' (YYYY-MM),
         * a 'date' object for sorting, and an array of 'cards' for that month.
         */
        function groupCardsByMonth(cards, selectedYear) {
            const monthsMap = new Map(); // Map to store { 'YYYY-MM': { key, date, cards: [] } }

            const filteredCards = cards.filter(card => {
                const parts = card.date.split('/');
                let year = parts.length === 3 ? parseInt(parts[2]) : new Date().getFullYear();
                // If the card date doesn't specify a year, assume it's for the current selected year
                // This handles cases where dates are just "dd/mm"
                return year === selectedYear || (parts.length === 2 && selectedYear === new Date().getFullYear());
            });

            filteredCards.forEach(card => {
                const parts = card.date.split('/');
                let day = parseInt(parts[0]);
                let month = parseInt(parts[1]); // Month is 1-indexed
                let year = parts.length === 3 ? parseInt(parts[2]) : selectedYear; // Use selectedYear if not provided

                // Create a Date object for sorting and key generation.
                // Month in Date constructor is 0-indexed.
                const dateForSorting = new Date(year, month - 1, day);
                const monthKey = `${year}-${String(month).padStart(2, '0')}`; // e.g., "2025-02"

                if (!monthsMap.has(monthKey)) {
                    monthsMap.set(monthKey, {
                        key: monthKey,
                        date: new Date(year, month - 1, 1), // Use 1st of the month for consistent sorting key
                        cards: []
                    });
                }
                monthsMap.get(monthKey).cards.push(card);
            });

            // Convert map values to an array and sort by the month's date (chronologically)
            const sortedMonths = Array.from(monthsMap.values()).sort((a, b) => b.date.getTime() - a.date.getTime());

            // Sort cards within each month by day
            sortedMonths.forEach(monthGroup => {
                monthGroup.cards.sort((a, b) => {
                    const aParts = a.date.split('/');
                    const bParts = b.date.split('/');
                    const aDay = parseInt(aParts[0]);
                    const bDay = parseInt(bParts[0]);
                    return bDay - aDay;
                });
            });

            return sortedMonths;
        }

        /**
         * Returns the full month name for a given 0-indexed month number.
         * @param {number} monthIndex - The 0-indexed month number (0 for January, 11 for December).
         * @returns {string} The full month name.
         */
        function getMonthName(monthIndex) {
            const monthNames = [
                "January", "February", "March", "April", "May", "June",
                "July", "August", "September", "October", "November", "December"
            ];
            return monthNames[monthIndex];
        }

        // Function to set up pagination buttons and their event listeners
        function createPagination() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            
            // Previous button event listener
            prevBtn.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderCards();
                    updatePagination();
                }
            });
            
            // Next button event listener
            nextBtn.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderCards();
                    updatePagination();
                }
            });
            
            // Initial update of pagination state
            updatePagination();
        }

        // Function to update the state of pagination buttons and page numbers
        function updatePagination() {
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const pageNumbersContainer = document.getElementById('pageNumbers');
            const paginationInfo = document.getElementById('paginationInfo');
            
            // Update button disabled states
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
            
            // Clear existing page numbers
            pageNumbersContainer.innerHTML = '';
            
            // Logic to display page numbers with ellipsis
            const maxVisiblePages = 5; // Max number of page buttons to show
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
            
            // Adjust startPage if not enough pages to fill maxVisiblePages from current position
            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }
            
            // Add first page button and ellipsis if needed
            if (startPage > 1) {
                const firstPage = createPageButton(1);
                pageNumbersContainer.appendChild(firstPage);
                
                if (startPage > 2) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
            }
            
            // Add visible page number buttons
            for (let i = startPage; i <= endPage; i++) {
                const pageBtn = createPageButton(i);
                pageNumbersContainer.appendChild(pageBtn);
            }
            
            // Add last page button and ellipsis if needed
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    const ellipsis = document.createElement('span');
                    ellipsis.className = 'pagination-ellipsis';
                    ellipsis.textContent = '...';
                    pageNumbersContainer.appendChild(ellipsis);
                }
                
                const lastPage = createPageButton(totalPages);
                pageNumbersContainer.appendChild(lastPage);
            }
            
            // Update pagination info text based on the current month's data
            if (groupedCardData.length > 0) {
                const currentMonthGroup = groupedCardData[currentPage - 1];
                const monthDate = currentMonthGroup.date;
                const monthName = getMonthName(monthDate.getMonth());
                const year = monthDate.getFullYear();
                const numberOfCardsInMonth = currentMonthGroup.cards.length;
                // paginationInfo.textContent = `Showing memories for ${monthName} ${year} (${numberOfCardsInMonth} cards)`;
            } else {
                // paginationInfo.textContent = `No memories to display for ${currentYear}.`;
            }
        }

        // Helper function to create a page number button
        function createPageButton(pageNumber) {
            const btn = document.createElement('button');
            // Get the month group for this page number
            const monthGroup = groupedCardData[pageNumber - 1];
            let buttonText = pageNumber; // Default to number if no month data
            if (monthGroup) {
                const monthDate = monthGroup.date;
                buttonText = `${monthDate.getMonth() + 1}`; // Display month number (1-indexed)
            }

            btn.className = `pagination-btn pagination-number ${pageNumber === currentPage ? 'active' : ''}`;
            btn.textContent = buttonText;
            btn.addEventListener('click', () => {
                currentPage = pageNumber;
                renderCards();
                updatePagination();
            });
            return btn;
        }

        // Function to render cards for the current page (which is now a month group)
        function renderCards() {
            cardGrid.innerHTML = ''; // Clear existing cards
            
            // Get the cards for the current month
            const currentMonthCards = groupedCardData[currentPage - 1]?.cards || [];
            
            currentMonthCards.forEach((card, index) => {
                const cardElement = document.createElement('div');
                // Apply special or sad classes based on card data
                if(card.isSpecial) {
                    cardElement.className = 'card special';
                    // Apply specific styles for special cards based on date
                    if (card.date === "4/5" || card.date === "9/4") {
                        cardElement.style.setProperty('--special-icon', "'‚ù§Ô∏è'");
                        cardElement.style.setProperty('--font-size', "35px");
                        cardElement.style.setProperty ('--animation', "heart-sparkle 3s ease-in-out infinite");
                    } else if (card.date === "7/6") {
                        cardElement.style.setProperty('--special-icon', "'üíØ'");
                        cardElement.style.setProperty('--font-size', "35px");
                        cardElement.style.setProperty('--animation', "heart-sparkle 3s ease-in-out infinite");
                    } else if (card.date === "6/5" || card.date === "22/5") {
                        cardElement.style.setProperty('--special-icon', "'üéüÔ∏è'");
                        cardElement.style.setProperty('--font-size', "35px");
                    }
                } else if (card.isSad) {
                    cardElement.className = 'card sad';
                } else {
                    cardElement.className = 'card';
                }

                // Apply random tilt to the card
                const randomTilt = (Math.random() * 10) - 5; // Random value between -5 and 5 degrees
                cardElement.style.transform = `rotate(${randomTilt}deg)`;
                
                // Determine content for the card front (single image or slideshow)
                let frontContent = '';
                if (Array.isArray(card.image) && card.image.length > 1) {
                    // Create slideshow for multiple images
                    frontContent = `
                        <div class="slideshow-container" data-card-index="${index}">
                            ${card.image.map((img, imgIndex) => `
                                <div class="slideshow-slide ${imgIndex === 0 ? 'active' : ''}" data-slide-index="${imgIndex}">
                                    <img src="./assets/img/${img}" alt="Love Memory ${index + 1}-${imgIndex + 1}">
                                </div>
                            `).join('')}
                            <div class="slideshow-controls">
                                ${card.image.map((_, dotIndex) => `
                                    <div class="slideshow-dot ${dotIndex === 0 ? 'active' : ''}" data-slide-index="${dotIndex}"></div>
                                `).join('')}
                            </div>
                            <button class="slideshow-btn slideshow-prev" data-card-index="${index}">&lt;</button>
                            <button class="slideshow-btn slideshow-next" data-card-index="${index}">&gt;</button>
                        </div>
                    `;
                } else {
                    // Single image display
                    const imgSrc = Array.isArray(card.image) ? card.image[0] : card.image;
                    frontContent = `<img src="./assets/img/${imgSrc}" alt="Love Card ${index + 1}">`;
                }
                
                // Populate card element with inner HTML
                cardElement.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front">
                            ${frontContent}
                        </div>
                        <div class="card-back">
                            <div class="card-header">${card.date}</div>
                            <div class="card-divider"></div>
                            <div class="card-message">
                                <p>${card.message}</p>
                            </div>
                        </div>
                    </div>
                `;
                cardGrid.appendChild(cardElement);
                
                // Add flip functionality to the card
                cardElement.addEventListener('click', function(e) {
                    // Prevent flipping if clicking on slideshow controls
                    if (e.target.closest('.slideshow-btn') || e.target.closest('.slideshow-dot')) {
                        e.stopPropagation();
                        return;
                    }
                    
                    this.classList.toggle('flipped');
                    // Create more hearts for special cards
                    const heartCount = card.isSpecial ? 30 : 20;
                    createHeartRain(heartCount);
                });
            });
            
            // Re-setup slideshows for newly rendered cards
            setupSlideshows();
        }

        // Function to calculate days since a given date
        function daysSince(dateString) {
            const oneDay = 24 * 60 * 60 * 1000; // hours * minutes * seconds * milliseconds
            const givenDate = new Date(dateString);
            const today = new Date();

            // Ensure time is not considered for accurate day count
            givenDate.setHours(0, 0, 0, 0);
            today.setHours(0, 0, 0, 0);

            const diffInTime = today - givenDate;
            const diffInDays = Math.floor(diffInTime / oneDay);

            return diffInDays;
        }

        // Function to initialize music playback
        function initializeMusic() {
            const bgMusic = document.getElementById('bgMusic');
            bgMusic.volume = 0.3; // Set initial volume
            
            // Function to attempt playing music
            const attemptPlayMusic = function() {
                bgMusic.play().catch(error => {
                    console.log("Still waiting for user interaction to play music: ", error);
                });
            };
            
            // Try to play on various user interactions
            const userInteractions = ['click', 'touchstart', 'keydown', 'scroll', 'mousemove'];
            
            userInteractions.forEach(event => {
                document.addEventListener(event, function interactionHandler() {
                    attemptPlayMusic();
                    // If successful play occurs, remove all listeners
                    bgMusic.addEventListener('playing', function() {
                        userInteractions.forEach(evt => {
                            document.removeEventListener(evt, interactionHandler);
                        });
                        console.log("Music started successfully!");
                    });
                }, { once: false }); // May need multiple attempts
            });
            
            // Also try when page becomes visible (e.g., switching tabs)
            document.addEventListener('visibilitychange', function() {
                if (document.visibilityState === 'visible') {
                    attemptPlayMusic();
                }
            });
        }

        // Add slideshow functionality
        function setupSlideshows() {
            // Set up next/prev buttons for all slideshows
            document.querySelectorAll('.slideshow-btn').forEach(btn => {
                // Remove previous event listeners to prevent duplicates on re-render
                const oldBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(oldBtn, btn);
                oldBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const cardIndex = this.getAttribute('data-card-index');
                    const container = document.querySelector(`.slideshow-container[data-card-index="${cardIndex}"]`);
                    if (!container) return;
                    
                    const slides = container.querySelectorAll('.slideshow-slide');
                    const dots = container.querySelectorAll('.slideshow-dot');
                    
                    // Find current active slide
                    let currentIndex = 0;
                    slides.forEach((slide, idx) => {
                        if (slide.classList.contains('active')) {
                            currentIndex = idx;
                        }
                    });
                    
                    // Calculate new index
                    let newIndex;
                    if (this.classList.contains('slideshow-next')) {
                        newIndex = (currentIndex + 1) % slides.length;
                    } else {
                        newIndex = (currentIndex - 1 + slides.length) % slides.length;
                    }
                    
                    // Update active slide and dot
                    slides[currentIndex].classList.remove('active');
                    dots[currentIndex].classList.remove('active');
                    slides[newIndex].classList.add('active');
                    dots[newIndex].classList.add('active');
                    
                    createHeartRain(5); // Create a few hearts on slide change
                });
            });
            
            // Set up dots for all slideshows
            document.querySelectorAll('.slideshow-dot').forEach(dot => {
                // Remove previous event listeners to prevent duplicates on re-render
                const oldDot = dot.cloneNode(true);
                dot.parentNode.replaceChild(oldDot, dot);
                oldDot.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const slideIndex = this.getAttribute('data-slide-index');
                    const container = this.closest('.slideshow-container');
                    const slides = container.querySelectorAll('.slideshow-slide');
                    const dots = container.querySelectorAll('.slideshow-dot');
                    
                    // Remove active class from all slides and dots
                    slides.forEach(slide => slide.classList.remove('active'));
                    dots.forEach(dot => dot.classList.remove('active'));
                    
                    // Add active class to selected slide and dot
                    slides[slideIndex].classList.add('active');
                    this.classList.add('active');
                    
                    createHeartRain(5); // Create a few hearts on slide change
                });
            });
            
            // Auto-advance slideshows
            const slideshows = document.querySelectorAll('.slideshow-container');
            slideshows.forEach(slideshow => {
                // Clear any existing intervals to prevent multiple auto-advances
                if (slideshow.autoAdvanceInterval) {
                    clearInterval(slideshow.autoAdvanceInterval);
                }
                const cardIndex = slideshow.getAttribute('data-card-index');
                slideshow.autoAdvanceInterval = setInterval(() => {
                    // Only auto-advance if the card is not flipped
                    const card = slideshow.closest('.card');
                    if (!card.classList.contains('flipped')) {
                        const nextBtn = slideshow.querySelector('.slideshow-next');
                        if (nextBtn) nextBtn.click();
                    }
                }, 2700 + (parseInt(cardIndex) * 400)); // Stagger the timers slightly
            });
        }

        // Function to create falling hearts
        function createHeart(className = 'heart') {
            const heart = document.createElement('div');
            heart.className = className;
            heart.innerHTML = '‚ù§';
            heart.style.left = Math.random() * 100 + 'vw';
            heart.style.top = '-50px'; // Start above the viewport
            heart.style.animationDuration = Math.random() * 3 + 2 + 's';
            heart.style.fontSize = Math.random() * 24 + 10 + 'px';
            heart.style.opacity = Math.random() * 0.5 + 0.5;
            document.body.appendChild(heart);
            
            // Remove heart after animation completes
            setTimeout(() => {
                heart.remove();
            }, 5000);
            
            return heart;
        }

        // Create falling hearts on click anywhere on the document
        document.addEventListener('click', (e) => {
            // Don't create hearts for specific element clicks as they have their own heart animations
            if (e.target.closest('.card') || e.target.closest('.picture-frame') || e.target.closest('.music-controls') || e.target.closest('.slideshow-btn') || e.target.closest('.slideshow-dot') || e.target.closest('.pagination-btn') || e.target.closest('#yearSelect') || e.target.closest('#loveLetter')) {
                return;
            }
            const heart = createHeart();
            heart.style.left = e.clientX + 'px';
            heart.style.top = e.clientY + 'px';
        });

        // Function to create a rain of hearts
        function createHeartRain(count, className = 'heart') {
            for (let i = 0; i < count; i++) {
                setTimeout(() => {
                    createHeart(className);
                }, i * 50);
            }
        }

        // Global variable to store interval for continuous heart rain
        let heartRainInterval;

        // Function to continuously create hearts
        function createContinuousHeartRain() {
            // Create 1-3 hearts every interval
            const heartCount = Math.floor(Math.random() * 3) + 1;
            for (let i = 0; i < heartCount; i++) {
                createHeart();
            }
        }

        // Initial heart rain when page loads and continuous heart rain
        function startHeartAnimations() {
            // Initial burst of hearts
            for (let i = 0; i < 50; i++) {
                setTimeout(() => {
                    const heart = createHeart('initial-heart');
                    heart.style.left = Math.random() * 100 + 'vw';
                }, i * 50);
            }

            // Start continuous heart rain that never stops
            heartRainInterval = setInterval(createContinuousHeartRain, 400);
        }

        // Keep hearts falling even when tab is inactive
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                // If interval was cleared, restart it
                if (!heartRainInterval) {
                    heartRainInterval = setInterval(createContinuousHeartRain, 400);
                }
            } else {
                // Clear interval when tab is inactive to save resources
                if (heartRainInterval) {
                    clearInterval(heartRainInterval);
                    heartRainInterval = null;
                }
            }
        });

        // Music controls
        document.getElementById('playMusic').addEventListener('click', () => {
            const bgMusic = document.getElementById('bgMusic');
            const button = document.getElementById('playMusic');
            
            if (bgMusic.paused) { // Check if paused instead of muted for play/pause toggle
                bgMusic.play().then(() => {
                    button.innerHTML = 'üîä';
                }).catch(error => {
                    console.error("Error playing music:", error);
                });
            } else {
                bgMusic.pause(); // Pause the music
                button.innerHTML = 'üîá';
            }
        });
        
        // Add interaction to side pictures
        const pictures = document.querySelectorAll('.picture-frame');
        pictures.forEach(picture => {
            picture.addEventListener('click', () => {
                createHeartRain(15);
            });
        });

        // Make sure side pictures are positioned properly on window resize
        window.addEventListener('resize', () => {
            const sidePictures = document.querySelectorAll('.side-pictures');
            if (window.innerWidth <= 1400) {
                sidePictures.forEach(div => {
                    div.style.position = 'static';
                    div.style.transform = 'none';
                });
            } else {
                const leftPics = document.querySelector('.side-pictures.left');
                const rightPics = document.querySelector('.side-pictures.right');
                
                leftPics.style.position = 'fixed';
                leftPics.style.transform = 'translateY(-50%)';
                
                rightPics.style.position = 'fixed';
                rightPics.style.transform = 'translateY(-50%)';
            }
        });
    </script>
</body>
</html>
